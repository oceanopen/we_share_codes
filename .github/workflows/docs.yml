# https://docs.github.com/actions
name: Deploy Docs

on:
    # æ”¯æŒæ‰‹åŠ¨è§¦å‘æµæ°´çº¿
    workflow_dispatch:
    push:
        branches:
            - main
        paths:
            - packages/docs/**/**
            - package.json
            - .github/workflows/docs.yml

jobs:
    run:
        name: Docs Build & Deploy
        runs-on: ubuntu-latest

        env:
            # é…ç½®: https://github.com/oceanopen/we_share_codes/settings/secrets/actions
            remote_host: ${{ secrets.CVM_IP }}
            remote_user: ${{ secrets.CVM_USER_NAME }}
            remote_ssh_key: ${{ secrets.CVM_PRIVATE_KEY }}

        steps:
            - name: Checkout
              uses: actions/checkout@v4 # https://github.com/marketplace/actions/checkout

            - name: Setup Node
              uses: actions/setup-node@v4 # https://github.com/marketplace/actions/setup-node-js-environment
              with:
                  node-version: 20

            - name: Cache node_modules
              id: cache-node-modules
              uses: actions/cache@v4
              env:
                  cache-name: cache-node-modules
              with:
                  path: node_modules
                  key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-build-${{ env.cache-name }}-

            # 'true' - ä»£è¡¨ç¼“å­˜å‘½ä¸­, node_modules æ²¡æœ‰å˜åŒ–;
            # '' - ä»£è¡¨æ²¡æœ‰å‘½ä¸­, node_modules å‘ç”Ÿå˜åŒ–;
            - name: Debug Cache Hit
              run: echo "cache-node-modules:${{ steps.cache-node-modules.outputs.cache-hit }}"

            - name: Install pnpm
              run: npm install -g pnpm

            # This project is built using npm and outputs the result to the 'build' folder. Replace with the commands required to build your project, or remove this step entirely if your site is pre-built.
            - name: Install dependencies and Build ğŸ”§
              run: pnpm bootstrap && pnpm docs:build:prod

            - name: Deploy to Server
              uses: easingthemes/ssh-deploy@main # https://github.com/marketplace/actions/ssh-deploy
              if: env.remote_host && env.remote_user && env.remote_ssh_key
              with:
                  # æœåŠ¡å™¨åŸŸå
                  REMOTE_HOST: ${{ secrets.CVM_IP }}
                  # è…¾è®¯äº‘é»˜è®¤ç”¨æˆ·åä¸º root
                  REMOTE_USER: ${{ secrets.CVM_USER_NAME }}
                  # æœ¬åœ° .ssh æ–‡ä»¶ä¸‹çš„ç§é’¥ id_rsaï¼Œå­˜åœ¨ secrets çš„ TOKEN ä¸­
                  SSH_PRIVATE_KEY: ${{ secrets.CVM_PRIVATE_KEY }}
                  # å¤åˆ¶æ“ä½œçš„å‚æ•°ã€‚"-avzr --delete" æ„å‘³éƒ¨ç½²æ—¶æ¸…ç©ºæœåŠ¡å™¨ç›®æ ‡ç›®å½•ä¸‹çš„æ–‡ä»¶
                  # æºç›®å½•ï¼Œç›¸å¯¹äº $GITHUB_WORKSPACE æ ¹ç›®å½•çš„è·¯å¾„
                  SOURCE: packages/docs/dist/
                  # ç›®æ ‡ç›®å½•
                  TARGET: /data/web/${{ github.event.repository.name }}/docs
